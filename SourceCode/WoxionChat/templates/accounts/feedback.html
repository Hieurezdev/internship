<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Survey Widget</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
        }
        #survey-container {
            width: 450px; /* Chi·ªÅu r·ªông c·ªßa widget */
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 25px;
            box-sizing: border-box;
        }
        #survey-header {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
            font-size: 1.8em;
            font-weight: bold;
        }
        #question-display {
            min-height: 80px;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #555;
            line-height: 1.5;
        }
        #options-container {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .option-btn {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            padding: 12px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            text-align: left;
            transition: background-color 0.2s, border-color 0.2s;
            position: relative; /* Cho checkbox/radio */
        }
        .option-btn.selected {
            background-color: #e0f0e0;
            border-color: #4CAF50;
            font-weight: bold;
        }
        .option-btn:hover {
            background-color: #e9e9e9;
        }
        .text-input-field {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            margin-top: 10px;
        }
        #nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }
        .nav-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.2s;
        }
        .nav-btn:hover {
            background-color: #45a049;
        }
        .nav-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #thank-you-message {
            text-align: center;
            font-size: 1.3em;
            color: #4CAF50;
            font-weight: bold;
            margin-top: 50px;
            display: none; /* Ban ƒë·∫ßu ·∫©n */
        }

        #countdown-text {
            font-size: 1.1em;
            color: #666;
            margin: 15px 0;
            font-weight: normal;
        }

        #countdown {
            font-weight: bold;
            color: #4CAF50;
            font-size: 1.2em;
        }

        /* Styles cho checkbox/radio trong n√∫t */
        .option-btn input[type="radio"],
        .option-btn input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .custom-radio, .custom-checkbox {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #555;
            border-radius: 50%; /* Cho radio */
            margin-right: 10px;
            vertical-align: middle;
            position: relative;
        }
        .custom-checkbox {
            border-radius: 3px; /* Cho checkbox */
        }
        .option-btn input[type="radio"]:checked + .custom-radio:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
        }
        .option-btn input[type="checkbox"]:checked + .custom-checkbox:after {
            content: '‚úî';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #4CAF50;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="survey-container">
        <div id="survey-header">Kh·∫£o S√°t Chatbot</div>
        <div id="question-display"></div>
        <div id="options-container"></div>
        <input type="text" id="text-input" class="text-input-field" style="display:none;" placeholder="Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi...">

        <div id="nav-buttons">
            <button id="prev-btn" class="nav-btn" disabled>Quay l·∫°i</button>
            <button id="next-btn" class="nav-btn">Ti·∫øp theo</button>
        </div>
        <div id="thank-you-message">C·∫£m ∆°n b·∫°n ƒë√£ ho√†n th√†nh kh·∫£o s√°t!</div>
    </div>

    <script>
        // --- ƒê·ªãnh nghƒ©a c√°c c√¢u h·ªèi kh·∫£o s√°t (Gi·ªØ nguy√™n nh∆∞ trong Python code, nh∆∞ng c√≥ th√™m field 'key') ---
        const SURVEY_QUESTIONS = {
            "q1_overall_satisfaction": { "key": "q1_overall_satisfaction", "text": "Nh√¨n chung, b·∫°n h√†i l√≤ng ƒë·∫øn m·ª©c ƒë·ªô n√†o v·ªõi l·∫ßn t∆∞∆°ng t√°c g·∫ßn ƒë√¢y nh·∫•t c·ªßa m√¨nh v·ªõi chatbot?", "options": { "1": "1 - R·∫•t kh√¥ng h√†i l√≤ng", "2": "2 - Kh√¥ng h√†i l√≤ng", "3": "3 - B√¨nh th∆∞·ªùng", "4": "4 - H√†i l√≤ng", "5": "5 - R·∫•t h√†i l√≤ng" }, "db_field": "overall_satisfaction", "type": "rating" },
            "q2_ease_of_use": { "key": "q2_ease_of_use", "text": "B·∫°n th·∫•y vi·ªác s·ª≠ d·ª•ng chatbot c√≥ d·ªÖ d√†ng kh√¥ng?", "options": { "1": "1 - R·∫•t kh√≥", "2": "2 - Kh√≥", "3": "3 - B√¨nh th∆∞·ªùng", "4": "4 - D·ªÖ", "5": "5 - R·∫•t d·ªÖ" }, "db_field": "ease_of_use", "type": "rating" },
            "q3_time_saving": { "key": "q3_time_saving", "text": "B·∫°n c√≥ c·∫£m th·∫•y chatbot ƒë√£ ti·∫øt ki·ªám th·ªùi gian c·ªßa b·∫°n trong qu√° tr√¨nh t∆∞∆°ng t√°c kh√¥ng?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng (t·ªën th·ªùi gian h∆°n)", "2": "2 - √çt ti·∫øt ki·ªám th·ªùi gian", "3": "3 - Kh√¥ng ·∫£nh h∆∞·ªüng nhi·ªÅu", "4": "4 - Ti·∫øt ki·ªám th·ªùi gian", "5": "5 - R·∫•t ti·∫øt ki·ªám th·ªùi gian" }, "db_field": "time_saving", "type": "rating" },
            "q4_recommendation": { "key": "q4_recommendation", "text": "B·∫°n c√≥ s·∫µn l√≤ng gi·ªõi thi·ªáu chatbot c·ªßa ch√∫ng t√¥i cho ng∆∞·ªùi kh√°c kh√¥ng?", "options": { "1": "1 - Ch·∫Øc ch·∫Øn kh√¥ng", "2": "2 - Kh√¥ng ch·∫Øc ch·∫Øn", "3": "3 - B√¨nh th∆∞·ªùng", "4": "4 - C√≥ th·ªÉ", "5": "5 - Ch·∫Øc ch·∫Øn c√≥" }, "db_field": "recommendation", "type": "rating" },
            "q5_understanding_accuracy": { "key": "q5_understanding_accuracy", "text": "Chatbot ƒë√£ hi·ªÉu ch√≠nh x√°c c√¢u h·ªèi ho·∫∑c y√™u c·∫ßu c·ªßa b·∫°n ƒë·∫øn m·ª©c ƒë·ªô n√†o?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng ch√≠nh x√°c", "2": "2 - K√©m ch√≠nh x√°c", "3": "3 - T∆∞∆°ng ƒë·ªëi ch√≠nh x√°c", "4": "4 - Ch√≠nh x√°c", "5": "5 - C·ª±c k·ª≥ ch√≠nh x√°c" }, "db_field": "understanding_accuracy", "type": "rating" },
            "q6_clarification_prompts": { "key": "q6_clarification_prompts", "text": "Khi chatbot kh√¥ng hi·ªÉu y√™u c·∫ßu c·ªßa b·∫°n, n√≥ c√≥ ƒë∆∞a ra c√°c c√¢u h·ªèi l√†m r√µ ho·∫∑c g·ª£i √Ω ph√π h·ª£p kh√¥ng?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng", "2": "2 - H·∫ßu nh∆∞ kh√¥ng", "3": "3 - Th·ªânh tho·∫£ng", "4": "4 - Th∆∞·ªùng xuy√™n", "5": "5 - Lu√¥n lu√¥n" }, "db_field": "clarification_prompts", "type": "rating" },
            "q7_info_clarity": { "key": "q7_info_clarity", "text": "Th√¥ng tin do chatbot cung c·∫•p c√≥ r√µ r√†ng v√† d·ªÖ hi·ªÉu kh√¥ng?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng r√µ r√†ng", "2": "2 - Kh√≥ hi·ªÉu", "3": "3 - T∆∞∆°ng ƒë·ªëi r√µ r√†ng", "4": "4 - R√µ r√†ng", "5": "5 - R·∫•t r√µ r√†ng" }, "db_field": "info_clarity", "type": "rating" },
            "q8_info_completeness": { "key": "q8_info_completeness", "text": "Th√¥ng tin do chatbot cung c·∫•p c√≥ ƒë·∫ßy ƒë·ªß v√† to√†n di·ªán kh√¥ng?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng ƒë·∫ßy ƒë·ªß", "2": "2 - √çt ƒë·∫ßy ƒë·ªß", "3": "3 - Kh√° ƒë·∫ßy ƒë·ªß", "4": "4 - ƒê·∫ßy ƒë·ªß", "5": "5 - R·∫•t ƒë·∫ßy ƒë·ªß" }, "db_field": "info_completeness", "type": "rating" },
            "q9_info_trustworthiness": { "key": "q9_info_trustworthiness", "text": "B·∫°n c√≥ c·∫£m th·∫•y tin t∆∞·ªüng v√†o t√≠nh ch√≠nh x√°c c·ªßa th√¥ng tin m√† chatbot cung c·∫•p kh√¥ng?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng tin t∆∞·ªüng", "2": "2 - √çt tin t∆∞·ªüng", "3": "3 - T∆∞∆°ng ƒë·ªëi tin t∆∞·ªüng", "4": "4 - Tin t∆∞·ªüng", "5": "5 - R·∫•t tin t∆∞·ªüng" }, "db_field": "info_trustworthiness", "type": "rating" },
            "q10_response_speed": { "key": "q10_response_speed", "text": "T·ªëc ƒë·ªô ph·∫£n h·ªìi c·ªßa chatbot c√≥ ƒë√°p ·ª©ng k·ª≥ v·ªçng c·ªßa b·∫°n kh√¥ng?", "options": { "1": "1 - Ch·∫≠m h∆°n nhi·ªÅu so v·ªõi k·ª≥ v·ªçng", "2": "2 - Ch·∫≠m h∆°n k·ª≥ v·ªçng", "3": "3 - ƒê√°p ·ª©ng v·ª´a ƒë·ªß k·ª≥ v·ªçng", "4": "4 - Nhanh h∆°n k·ª≥ v·ªçng", "5": "5 - Nhanh h∆°n nhi·ªÅu so v·ªõi k·ª≥ v·ªçng" }, "db_field": "response_speed", "type": "rating" },
            "q11_problem_solving_usefulness": { "key": "q11_problem_solving_usefulness", "text": "Chatbot ƒë√£ h·ªØu √≠ch ƒë·∫øn m·ª©c ƒë·ªô n√†o trong vi·ªác gi·∫£i quy·∫øt th·∫Øc m·∫Øc ho·∫∑c v·∫•n ƒë·ªÅ c·ªßa b·∫°n?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng h·ªØu √≠ch", "2": "2 - √çt h·ªØu √≠ch", "3": "3 - Kh√° h·ªØu √≠ch", "4": "4 - H·ªØu √≠ch", "5": "5 - C·ª±c k·ª≥ h·ªØu √≠ch" }, "db_field": "problem_solving_usefulness", "type": "rating" },
            "q12_instant_resolution": { "key": "q12_instant_resolution", "text": "Chatbot c√≥ th·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ c·ªßa b·∫°n ngay l·∫≠p t·ª©c kh√¥ng (kh√¥ng c·∫ßn chuy·ªÉn ti·∫øp ƒë·∫øn ng∆∞·ªùi th·∫≠t)?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng th·ªÉ", "2": "2 - H·∫ßu nh∆∞ kh√¥ng th·ªÉ", "3": "3 - Th·ªânh tho·∫£ng c√≥ th·ªÉ", "4": "4 - Th∆∞·ªùng xuy√™n c√≥ th·ªÉ", "5": "5 - Lu√¥n lu√¥n c√≥ th·ªÉ" }, "db_field": "instant_resolution", "type": "rating" },
            "q13_next_steps_guidance": { "key": "q13_next_steps_guidance", "text": "Khi chatbot kh√¥ng th·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ c·ªßa b·∫°n, n√≥ c√≥ ƒë∆∞a ra c√°c l·ª±a ch·ªçn ho·∫∑c b∆∞·ªõc ti·∫øp theo ph√π h·ª£p kh√¥ng (v√≠ d·ª•: li√™n h·ªá nh√¢n vi√™n h·ªó tr·ª£, FAQ)?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng", "2": "2 - H·∫ßu nh∆∞ kh√¥ng", "3": "3 - Th·ªânh tho·∫£ng", "4": "4 - Th∆∞·ªùng xuy√™n", "5": "5 - Lu√¥n lu√¥n" }, "db_field": "next_steps_guidance", "type": "rating" },
            "q14_channel_transfer_comfort": { "key": "q14_channel_transfer_comfort", "text": "B·∫°n c·∫£m th·∫•y d·ªÖ ch·ªãu ƒë·∫øn m·ª©c ƒë·ªô n√†o v·ªõi vi·ªác chatbot chuy·ªÉn h∆∞·ªõng b·∫°n ƒë·∫øn m·ªôt k√™nh h·ªó tr·ª£ kh√°c khi c·∫ßn?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng d·ªÖ ch·ªãu", "2": "2 - √çt d·ªÖ ch·ªãu", "3": "3 - B√¨nh th∆∞·ªùng", "4": "4 - D·ªÖ ch·ªãu", "5": "5 - R·∫•t d·ªÖ ch·ªãu" }, "db_field": "channel_transfer_comfort", "type": "rating" },
            "q15_final_solution_satisfaction": { "key": "q15_final_solution_satisfaction", "text": "B·∫°n c√≥ c·∫£m th·∫•y h√†i l√≤ng v·ªõi gi·∫£i ph√°p ho·∫∑c th√¥ng tin cu·ªëi c√πng m√† b·∫°n nh·∫≠n ƒë∆∞·ª£c th√¥ng qua t∆∞∆°ng t√°c v·ªõi chatbot kh√¥ng?", "options": { "1": "1 - R·∫•t kh√¥ng h√†i l√≤ng", "2": "2 - Kh√¥ng h√†i l√≤ng", "3": "3 - B√¨nh th∆∞·ªùng", "4": "4 - H√†i l√≤ng", "5": "5 - R·∫•t h√†i l√≤ng" }, "db_field": "final_solution_satisfaction", "type": "rating" },
            "q16_interface_usability": { "key": "q16_interface_usability", "text": "Giao di·ªán chatbot c√≥ d·ªÖ nh√¨n v√† d·ªÖ ƒëi·ªÅu h∆∞·ªõng kh√¥ng?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng", "2": "2 - Kh√° kh√≥", "3": "3 - Trung b√¨nh", "4": "4 - D·ªÖ", "5": "5 - R·∫•t d·ªÖ" }, "db_field": "interface_usability", "type": "rating" },
            "q17_communication_style": { "key": "q17_communication_style", "text": "C√°ch giao ti·∫øp c·ªßa chatbot (t·ª´ ng·ªØ, gi·ªçng ƒëi·ªáu) c√≥ ph√π h·ª£p v√† d·ªÖ ch·ªãu kh√¥ng?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng ph√π h·ª£p", "2": "2 - √çt ph√π h·ª£p", "3": "3 - Trung b√¨nh", "4": "4 - Ph√π h·ª£p", "5": "5 - R·∫•t ph√π h·ª£p" }, "db_field": "communication_style", "type": "rating" },
            "q18_friendliness": { "key": "q18_friendliness", "text": "B·∫°n c√≥ c·∫£m th·∫•y chatbot th√¢n thi·ªán trong qu√° tr√¨nh t∆∞∆°ng t√°c kh√¥ng?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng th√¢n thi·ªán", "2": "2 - √çt th√¢n thi·ªán", "3": "3 - Trung b√¨nh", "4": "4 - Th√¢n thi·ªán", "5": "5 - R·∫•t th√¢n thi·ªán" }, "db_field": "friendliness", "type": "rating" },
            "q19_personalization": { "key": "q19_personalization", "text": "B·∫°n c√≥ c·∫£m th·∫•y chatbot c√° nh√¢n h√≥a ƒë∆∞·ª£c ph·∫£n h·ªìi cho tr∆∞·ªùng h·ª£p c·ªßa b·∫°n kh√¥ng?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng (qu√° chung chung)", "2": "2 - √çt c√° nh√¢n h√≥a", "3": "3 - B√¨nh th∆∞·ªùng", "4": "4 - C√° nh√¢n h√≥a", "5": "5 - R·∫•t c√° nh√¢n h√≥a" }, "db_field": "personalization", "type": "rating" },
            "q20_professionalism": { "key": "q20_professionalism", "text": "B·∫°n c√≥ c·∫£m th·∫•y chatbot ƒë√£ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ c·ªßa b·∫°n m·ªôt c√°ch chuy√™n nghi·ªáp kh√¥ng?", "options": { "1": "1 - Ho√†n to√†n kh√¥ng chuy√™n nghi·ªáp", "2": "2 - √çt chuy√™n nghi·ªáp", "3": "3 - Trung b√¨nh", "4": "4 - Chuy√™n nghi·ªáp", "5": "5 - R·∫•t chuy√™n nghi·ªáp" }, "db_field": "professionalism", "type": "rating" },
            "q21_frustration_level": { "key": "q21_frustration_level", "text": "B·∫°n c√≥ c·∫£m th·∫•y frustration (th·∫•t v·ªçng/b·ª±c b·ªôi) khi t∆∞∆°ng t√°c v·ªõi chatbot kh√¥ng?", "options": { "1": "1 - R·∫•t th∆∞·ªùng xuy√™n", "2": "2 - Th∆∞·ªùng xuy√™n", "3": "3 - Th·ªânh tho·∫£ng", "4": "4 - Hi·∫øm khi", "5": "5 - H·∫ßu nh∆∞ kh√¥ng bao gi·ªù" }, "db_field": "frustration_level", "type": "rating" },
            "q22_desired_features": { "key": "q22_desired_features", "text": "Nh·ªØng t√≠nh nƒÉng n√†o b·∫°n mu·ªën chatbot c·ªßa ch√∫ng t√¥i c√≥ th√™m trong t∆∞∆°ng lai?", "options": { "A": "Kh·∫£ nƒÉng ghi nh·ªõ l·ªãch s·ª≠ cu·ªôc tr√≤ chuy·ªán", "B": "Kh·∫£ nƒÉng t·ª± ƒë·ªông ƒëi·ªÅn form/th·ª±c hi·ªán giao d·ªãch", "C": "H·ªó tr·ª£ ƒëa ng√¥n ng·ªØ", "D": "T√≠ch h·ª£p v·ªõi c√°c h·ªá th·ªëng/·ª©ng d·ª•ng kh√°c", "E": "G·ª≠i t√†i li·ªáu/file ƒë√≠nh k√®m", "F": "Kh√°c" }, "db_field": "desired_features", "type": "multiple_choice_with_other" },
            "q23_receive_notifications": { "key": "q23_receive_notifications", "text": "B·∫°n c√≥ mu·ªën nh·∫≠n th√¥ng b√°o ho·∫∑c c·∫≠p nh·∫≠t t·ª´ chatbot v·ªÅ c√°c t√≠nh nƒÉng m·ªõi kh√¥ng?", "options": { "A": "C√≥", "B": "Kh√¥ng" }, "db_field": "receive_notifications", "type": "single_choice" },
            "q24_reason_for_use": { "key": "q24_reason_for_use", "text": "L√Ω do ch√≠nh b·∫°n s·ª≠ d·ª•ng chatbot ng√†y h√¥m nay l√† g√¨?", "options": { "A": "T√¨m ki·∫øm th√¥ng tin", "B": "Gi·∫£i quy·∫øt m·ªôt v·∫•n ƒë·ªÅ/s·ª± c·ªë", "C": "Th·ª±c hi·ªán m·ªôt y√™u c·∫ßu", "D": "Trao ƒë·ªïi chung", "E": "Kh√°c" }, "db_field": "reason_for_use", "type": "multiple_choice_with_other" },
            "q25_previous_use": { "key": "q25_previous_use", "text": "B·∫°n ƒë√£ t·ª´ng s·ª≠ d·ª•ng chatbot c·ªßa ch√∫ng t√¥i tr∆∞·ªõc ƒë√¢y ch∆∞a?", "options": { "A": "C√≥", "B": "Kh√¥ng" }, "db_field": "previous_use", "type": "single_choice" },
            "q26_device_used": { "key": "q26_device_used", "text": "B·∫°n ƒë√£ s·ª≠ d·ª•ng thi·∫øt b·ªã n√†o ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi chatbot?", "options": { "A": "M√°y t√≠nh ƒë·ªÉ b√†n/Laptop", "B": "ƒêi·ªán tho·∫°i di ƒë·ªông", "C": "M√°y t√≠nh b·∫£ng", "D": "Kh√°c" }, "db_field": "device_used", "type": "single_choice" },
            "q27_age_group": { "key": "q27_age_group", "text": "B·∫°n thu·ªôc nh√≥m tu·ªïi n√†o?", "options": { "A": "D∆∞·ªõi 18", "B": "18-24", "C": "25-34", "D": "35-44", "E": "45-54", "F": "55 tr·ªü l√™n" }, "db_field": "age_group", "type": "single_choice" },
            "q_other_desired_features_text": { "key": "q_other_desired_features_text", "text": "Vui l√≤ng ghi r√µ t√≠nh nƒÉng kh√°c b·∫°n mong mu·ªën:", "db_field": "other_desired_features_text", "type": "text_input", "depends_on": { "q22_desired_features": "F" } },
            "q_other_reason_for_use_text": { "key": "q_other_reason_for_use_text", "text": "Vui l√≤ng ghi r√µ l√Ω do kh√°c b·∫°n s·ª≠ d·ª•ng chatbot:", "db_field": "other_reason_for_use_text", "type": "text_input", "depends_on": { "q24_reason_for_use": "E" } }
        };

        const SURVEY_QUESTION_ORDER = [
            "q1_overall_satisfaction", "q2_ease_of_use", "q3_time_saving", "q4_recommendation",
            "q5_understanding_accuracy", "q6_clarification_prompts", "q7_info_clarity", "q8_info_completeness",
            "q9_info_trustworthiness", "q10_response_speed", "q11_problem_solving_usefulness",
            "q12_instant_resolution", "q13_next_steps_guidance", "q14_channel_transfer_comfort",
            "q15_final_solution_satisfaction", "q16_interface_usability", "q17_communication_style",
            "q18_friendliness", "q19_personalization", "q20_professionalism", "q21_frustration_level",
            "q22_desired_features", "q23_receive_notifications", "q24_reason_for_use", "q25_previous_use",
            "q26_device_used", "q27_age_group",
            "q_other_desired_features_text", "q_other_reason_for_use_text"
        ];


        const questionDisplay = document.getElementById('question-display');
        const optionsContainer = document.getElementById('options-container');
        const textInput = document.getElementById('text-input');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const thankYouMessage = document.getElementById('thank-you-message');
        const surveyContainer = document.getElementById('survey-container');

        // === DJANGO INTEGRATION ===
        // S·ª≠ d·ª•ng Django API thay v√¨ Flask service
        const BACKEND_API_URL = '/api/feedback/submit/'; // Django API endpoint
        
        // L·∫•y user data t·ª´ Django context (ƒë∆∞·ª£c truy·ªÅn t·ª´ view)
        const USER_ID = '{{ user_id }}';  // T·ª´ Django context
        const SESSION_ID = '{{ session_id }}';  // T·ª´ Django context
        const USERNAME = '{{ user.username }}';  // T·ª´ Django context
        
        // Hi·ªÉn th·ªã th√¥ng tin user
        console.log('üîó Feedback Survey initialized for:', USERNAME, 'User ID:', USER_ID);

        let currentQuestionIndex = 0;
        let userAnswers = {}; // L∆∞u tr·ªØ t·∫•t c·∫£ c√¢u tr·∫£ l·ªùi ·ªü frontend
        let dynamicQuestionOrder = [...SURVEY_QUESTION_ORDER]; // Th·ª© t·ª± c√¢u h·ªèi ƒë·ªông


        function displayQuestion() {
            if (currentQuestionIndex >= dynamicQuestionOrder.length) {
                // ƒê√£ h·∫øt c√¢u h·ªèi
                submitSurvey();
                return;
            }

            const currentQKey = dynamicQuestionOrder[currentQuestionIndex];
            const questionInfo = SURVEY_QUESTIONS[currentQKey];

            // X·ª≠ l√Ω c√¢u h·ªèi ph·ª• thu·ªôc (depends_on)
            if (questionInfo.depends_on) {
                const depQKey = Object.keys(questionInfo.depends_on)[0];
                const depOptionKey = questionInfo.depends_on[depQKey];
                
                const depQInfo = SURVEY_QUESTIONS[depQKey];
                const prevAnswer = userAnswers[depQInfo.db_field];

                // Ki·ªÉm tra n·∫øu c√¢u tr·∫£ l·ªùi tr∆∞·ªõc ƒë√≥ k√≠ch ho·∫°t c√¢u h·ªèi hi·ªán t·∫°i
                // N·∫øu prevAnswer l√† m·∫£ng (multi-choice), ki·ªÉm tra xem c√≥ ch·ª©a option key kh√¥ng
                if (!(Array.isArray(prevAnswer) ? prevAnswer.includes(depQInfo.options[depOptionKey]) : prevAnswer === depQInfo.options[depOptionKey])) {
                    currentQuestionIndex++; // B·ªè qua c√¢u h·ªèi n√†y
                    displayQuestion(); // Hi·ªÉn th·ªã c√¢u h·ªèi ti·∫øp theo
                    return;
                }
            }


            questionDisplay.textContent = questionInfo.text;
            optionsContainer.innerHTML = '';
            textInput.style.display = 'none'; // ·∫®n input text m·∫∑c ƒë·ªãnh
            optionsContainer.style.display = 'flex'; // Hi·ªÉn th·ªã container n√∫t m·∫∑c ƒë·ªãnh

            if (questionInfo.type === 'rating' || questionInfo.type === 'single_choice') {
                for (const key in questionInfo.options) {
                    const label = questionInfo.options[key];
                    const btn = document.createElement('button');
                    btn.classList.add('option-btn');
                    
                    // T·∫°o input radio ·∫©n
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = currentQKey;
                    radio.value = key; // Gi√° tr·ªã ƒë·ªÉ l∆∞u (1,2,3,4,5 ho·∫∑c A,B,C)
                    
                    // T·∫°o custom radio/checkbox UI
                    const customSpan = document.createElement('span');
                    customSpan.classList.add(questionInfo.type === 'rating' ? 'custom-radio' : 'custom-checkbox');

                    btn.appendChild(radio);
                    btn.appendChild(customSpan);
                    btn.appendChild(document.createTextNode(label)); // Th√™m text node cho label

                    btn.onclick = () => {
                        // B·ªè ch·ªçn t·∫•t c·∫£ c√°c n√∫t kh√°c trong c√πng c√¢u h·ªèi
                        document.querySelectorAll(`#options-container .option-btn`).forEach(b => {
                            b.classList.remove('selected');
                            b.querySelector('input').checked = false; // B·ªè check input radio
                        });
                        btn.classList.add('selected');
                        radio.checked = true; // Ch·ªçn input radio
                        userAnswers[questionInfo.db_field] = questionInfo.type === 'rating' ? parseInt(key) : questionInfo.options[key];
                        updateNavButtons();
                    };

                    // N·∫øu ƒë√£ c√≥ c√¢u tr·∫£ l·ªùi tr∆∞·ªõc ƒë√≥, ch·ªçn l·∫°i
                    if (userAnswers[questionInfo.db_field] === (questionInfo.type === 'rating' ? parseInt(key) : questionInfo.options[key])) {
                        btn.classList.add('selected');
                        radio.checked = true;
                    }

                    optionsContainer.appendChild(btn);
                }
            } else if (questionInfo.type === 'multiple_choice_with_other') {
                for (const key in questionInfo.options) {
                    const label = questionInfo.options[key];
                    const btn = document.createElement('button');
                    btn.classList.add('option-btn');

                    // T·∫°o input checkbox ·∫©n
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = currentQKey;
                    checkbox.value = key; // Gi√° tr·ªã ƒë·ªÉ l∆∞u (A,B,C,F)
                    
                    const customSpan = document.createElement('span');
                    customSpan.classList.add('custom-checkbox');

                    btn.appendChild(checkbox);
                    btn.appendChild(customSpan);
                    btn.appendChild(document.createTextNode(label));

                    btn.onclick = () => {
                        checkbox.checked = !checkbox.checked; // ƒê·∫£o ng∆∞·ª£c tr·∫°ng th√°i check
                        btn.classList.toggle('selected', checkbox.checked); // Th√™m/b·ªè class selected

                        // C·∫≠p nh·∫≠t userAnswers cho multi-choice
                        let currentSelections = userAnswers[questionInfo.db_field] || [];
                        const optionValue = questionInfo.options[key];
                        if (checkbox.checked) {
                            if (!currentSelections.includes(optionValue)) {
                                currentSelections.push(optionValue);
                            }
                        } else {
                            currentSelections = currentSelections.filter(item => item !== optionValue);
                        }
                        userAnswers[questionInfo.db_field] = currentSelections;

                        // X·ª≠ l√Ω ch√®n c√¢u h·ªèi "Kh√°c" n·∫øu ch·ªçn
                        if (key === 'F' || key === 'E') { // 'E' cho reason_for_use
                            const otherQKey = currentQKey === "q22_desired_features" ? "q_other_desired_features_text" : "q_other_reason_for_use_text";
                            const otherQIndex = dynamicQuestionOrder.indexOf(otherQKey);
                            if (checkbox.checked && otherQIndex === -1) {
                                dynamicQuestionOrder.splice(currentQuestionIndex + 1, 0, otherQKey);
                            } else if (!checkbox.checked && otherQIndex !== -1) {
                                dynamicQuestionOrder.splice(otherQIndex, 1);
                                delete userAnswers[SURVEY_QUESTIONS[otherQKey].db_field]; // X√≥a c√¢u tr·∫£ l·ªùi ph·ª• n·∫øu b·ªè ch·ªçn "Kh√°c"
                            }
                        }
                        updateNavButtons();
                    };

                    // N·∫øu ƒë√£ c√≥ c√¢u tr·∫£ l·ªùi tr∆∞·ªõc ƒë√≥, ch·ªçn l·∫°i
                    let prevSelections = userAnswers[questionInfo.db_field] || [];
                    if (prevSelections.includes(questionInfo.options[key])) {
                        btn.classList.add('selected');
                        checkbox.checked = true;
                    }
                    optionsContainer.appendChild(btn);
                }
            } else if (questionInfo.type === 'text_input') {
                textInput.style.display = 'block';
                optionsContainer.style.display = 'none'; // ·∫®n container n√∫t
                textInput.value = userAnswers[questionInfo.db_field] || '';
                textInput.focus();
            }
            updateNavButtons();
        }

        function saveCurrentAnswer() {
            const currentQKey = dynamicQuestionOrder[currentQuestionIndex];
            const questionInfo = SURVEY_QUESTIONS[currentQKey];

            if (questionInfo.type === 'text_input') {
                userAnswers[questionInfo.db_field] = textInput.value.trim();
            }
            // C√°c lo·∫°i kh√°c ƒë√£ ƒë∆∞·ª£c l∆∞u trong h√†m `onclick` c·ªßa n√∫t
        }

        function updateNavButtons() {
            prevBtn.disabled = currentQuestionIndex === 0;
            if (currentQuestionIndex === dynamicQuestionOrder.length - 1) {
                nextBtn.textContent = 'Ho√†n th√†nh';
            } else {
                nextBtn.textContent = 'Ti·∫øp theo';
            }
            // ƒêi·ªÅu ki·ªán ƒë·ªÉ n√∫t ti·∫øp theo kh√¥ng b·ªã disabled n·∫øu c√¢u tr·∫£ l·ªùi ch∆∞a c√≥
            const currentQKey = dynamicQuestionOrder[currentQuestionIndex];
            const questionInfo = SURVEY_QUESTIONS[currentQKey];
            
            let isAnswered = false;
            if (questionInfo.type === 'text_input') {
                isAnswered = textInput.value.trim() !== '';
            } else if (questionInfo.type === 'multiple_choice_with_other') {
                isAnswered = userAnswers[questionInfo.db_field] && userAnswers[questionInfo.db_field].length > 0;
            } else { // rating ho·∫∑c single_choice
                isAnswered = userAnswers.hasOwnProperty(questionInfo.db_field);
            }
            nextBtn.disabled = !isAnswered;

            if (currentQuestionIndex >= dynamicQuestionOrder.length) {
                nextBtn.disabled = false; // Lu√¥n cho ph√©p ho√†n th√†nh n·∫øu ƒë√£ h·∫øt c√¢u h·ªèi
            }
        }


        async function submitSurvey() {
            surveyContainer.style.display = 'none';
            thankYouMessage.style.display = 'block';

            try {
                // L·∫•y CSRF token t·ª´ Django
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                  document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                                  getCookie('csrftoken');
                
                const payload = {
                    user_id: USER_ID,
                    session_id: SESSION_ID,
                    answers: userAnswers // G·ª≠i t·∫•t c·∫£ c√¢u tr·∫£ l·ªùi
                };
                
                console.log('üì§ Submitting feedback:', payload);
                
                const response = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,  // Django CSRF protection
                    },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();
                console.log('üì• Survey submission response:', data);

                if (response.ok && data.status === 'success') {
                    thankYouMessage.innerHTML = `
                        <h2>üéâ C·∫£m ∆°n ${USERNAME}!</h2>
                        <p>Ph·∫£n h·ªìi c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n th√†nh c√¥ng.</p>
                        <p>Ch√∫ng t√¥i s·∫Ω s·ª≠ d·ª•ng th√¥ng tin n√†y ƒë·ªÉ c·∫£i thi·ªán chatbot.</p>
                        <p id="countdown-text">T·ª± ƒë·ªông chuy·ªÉn v·ªÅ trang ch·ªß sau <span id="countdown">3</span> gi√¢y...</p>
                        <button onclick="window.location.href='/'" class="nav-btn" style="margin-top: 20px;">
                            Quay v·ªÅ trang ch·ªß ngay
                        </button>
                    `;
                    
                    // B·∫Øt ƒë·∫ßu countdown v√† t·ª± ƒë·ªông redirect
                    let countdownTime = 3;
                    const countdownElement = document.getElementById('countdown');
                    
                    const countdownInterval = setInterval(() => {
                        countdownTime--;
                        if (countdownElement) {
                            countdownElement.textContent = countdownTime;
                        }
                        
                        if (countdownTime <= 0) {
                            clearInterval(countdownInterval);
                            window.location.href = '/';
                        }
                    }, 1000);
                    
                } else {
                    throw new Error(data.message || data.error || 'Unknown error');
                }

            } catch (error) {
                console.error('‚ùå Error submitting survey:', error);
                
                // Hi·ªÉn th·ªã l·ªói v√† cho ph√©p th·ª≠ l·∫°i
                thankYouMessage.innerHTML = `
                    <h2>‚ö†Ô∏è C√≥ l·ªói x·∫£y ra</h2>
                    <p>Kh√¥ng th·ªÉ g·ª≠i ph·∫£n h·ªìi: ${error.message}</p>
                    <button onclick="retrySubmit()" class="nav-btn" style="margin-top: 20px;">
                        Th·ª≠ l·∫°i
                    </button>
                    <button onclick="window.location.href='/'" class="nav-btn" style="margin-top: 10px;">
                        Quay v·ªÅ trang ch·ªß
                    </button>
                `;
            }
        }
        
        // Function to retry submission
        function retrySubmit() {
            thankYouMessage.style.display = 'none';
            surveyContainer.style.display = 'block';
        }
        
        // Function to get CSRF cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        prevBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                saveCurrentAnswer(); // L∆∞u c√¢u tr·∫£ l·ªùi hi·ªán t·∫°i tr∆∞·ªõc khi quay l·∫°i
                currentQuestionIndex--;
                // X·ª≠ l√Ω c√°c c√¢u h·ªèi "Kh√°c" n·∫øu quay l·∫°i v√† kh√¥ng c√≤n li√™n quan
                const prevQKey = dynamicQuestionOrder[currentQuestionIndex];
                const prevQInfo = SURVEY_QUESTIONS[prevQKey];
                if (prevQInfo.type === 'multiple_choice_with_other') {
                    const otherQKey = prevQKey === "q22_desired_features" ? "q_other_desired_features_text" : "q_other_reason_for_use_text";
                    const otherQIndex = dynamicQuestionOrder.indexOf(otherQKey);
                    // N·∫øu quay l·∫°i t·ª´ c√¢u h·ªèi "kh√°c" v√† n√≥ kh√¥ng c√≤n li√™n quan n·ªØa, b·ªè n√≥ ƒëi
                    // (ch·ªâ khi n√≥ ƒë∆∞·ª£c ch√®n ƒë·ªông V√Ä c√¢u tr·∫£ l·ªùi k√≠ch ho·∫°t n√≥ ƒë√£ b·ªã b·ªè ch·ªçn)
                    if (otherQIndex !== -1 && !((userAnswers[prevQInfo.db_field] || []).includes(prevQInfo.options['F'] || prevQInfo.options['E']))) {
                        dynamicQuestionOrder.splice(otherQIndex, 1);
                        delete userAnswers[SURVEY_QUESTIONS[otherQKey].db_field];
                        // N·∫øu c√¢u h·ªèi hi·ªán t·∫°i l√† c√¢u h·ªèi "Kh√°c" b·ªã x√≥a, quay l·∫°i th√™m 1 b∆∞·ªõc
                        if (currentQuestionIndex >= otherQIndex) {
                             currentQuestionIndex--;
                        }
                    }
                }
                displayQuestion();
            }
        });

        nextBtn.addEventListener('click', () => {
            saveCurrentAnswer(); // L∆∞u c√¢u tr·∫£ l·ªùi hi·ªán t·∫°i tr∆∞·ªõc khi chuy·ªÉn ti·∫øp

            // Ki·ªÉm tra xem c√¢u h·ªèi hi·ªán t·∫°i ƒë√£ ƒë∆∞·ª£c tr·∫£ l·ªùi ch∆∞a
            const currentQKey = dynamicQuestionOrder[currentQuestionIndex];
            const questionInfo = SURVEY_QUESTIONS[currentQKey];
            
            let isAnswered = false;
            if (questionInfo.type === 'text_input') {
                isAnswered = textInput.value.trim() !== '';
            } else if (questionInfo.type === 'multiple_choice_with_other') {
                isAnswered = userAnswers[questionInfo.db_field] && userAnswers[questionInfo.db_field].length > 0;
            } else { // rating ho·∫∑c single_choice
                isAnswered = userAnswers.hasOwnProperty(questionInfo.db_field);
            }

            if (!isAnswered) {
                alert('Vui l√≤ng tr·∫£ l·ªùi c√¢u h·ªèi tr∆∞·ªõc khi ti·∫øp t·ª•c.');
                return;
            }

            currentQuestionIndex++;
            displayQuestion();
        });

        // L·∫Øng nghe s·ª± ki·ªán input text ƒë·ªÉ c·∫≠p nh·∫≠t n√∫t Next
        textInput.addEventListener('input', updateNavButtons);


        // Kh·ªüi t·∫°o kh·∫£o s√°t khi t·∫£i trang
        displayQuestion();

    </script>
</body>
</html>